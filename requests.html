<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Venux - Friend Requests</title>
</head>
<body>
<h2>Incoming Friend Requests</h2>
<ul id="requestList"></ul>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
import { getFirestore, collection, getDocs, doc, deleteDoc, updateDoc, arrayUnion, getDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBPmJ-QYXZ41gx-4PjCpUPuw7DLnDq0JFg",
  authDomain: "venux1.firebaseapp.com",
  projectId: "venux1",
  storageBucket: "venux1.appspot.com",
  messagingSenderId: "231055963335",
  appId: "1:231055963335:web:34c2f52fca2191b3d0bae2",
  measurementId: "G-N36RRV95SW"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

onAuthStateChanged(auth, async user => {
  if(!user) return window.location.href = "Login.html";

  const uid = user.uid;
  const requestList = document.getElementById("requestList");

  // Get all incoming requests
  const requestsRef = collection(db, "users", uid, "friendRequests");
  const snapshot = await getDocs(requestsRef);

  snapshot.forEach(async docSnap => {
    const requestData = docSnap.data();
    const senderId = requestData.senderId;

    // Fetch sender's username
    const senderDoc = await getDoc(doc(db, "users", senderId));
    const senderName = senderDoc.exists() ? senderDoc.data().username : senderId;

    const li = document.createElement("li");
    li.textContent = senderName + " ";

    const acceptBtn = document.createElement("button");
    acceptBtn.textContent = "Accept";
    acceptBtn.addEventListener("click", async () => {
      try {
        // Add each other to friends array
        await updateDoc(doc(db, "users", uid), { friends: arrayUnion(senderId) });
        await updateDoc(doc(db, "users", senderId), { friends: arrayUnion(uid) });
        // Delete the request
        await deleteDoc(doc(db, "users", uid, "friendRequests", docSnap.id));
        li.remove();
      } catch(err) {
        console.error("Failed to accept:", err);
        alert("Could not accept request: " + err.message);
      }
    });

    li.appendChild(acceptBtn);
    requestList.appendChild(li);
  });
});
</script>
</body>
</html>
