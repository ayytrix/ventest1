<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Venux - Forums</title>
<style>
/* ... keep all your existing CSS ... */
</style>
</head>
<body>

<div id="main-header">
  <img src="https://raw.githubusercontent.com/ayytrix/ventest1/refs/heads/main/venux.png" alt="Venux">
  <div class="auth-buttons" id="authButtons"></div>
</div>

<div id="sub-header">
  <a href="Home.html">Home</a><span class="nav-separator">|</span>
  <a href="Games.html">Games</a><span class="nav-separator">|</span>
  <a href="Catalog.html">Catalog</a><span class="nav-separator">|</span>
  <a href="Users.html">Users</a><span class="nav-separator">|</span>
  <a href="Forums.html">Forum</a><span class="nav-separator">|</span>
  <a href="Clans.html">Clans</a><span class="nav-separator">|</span>
  <a href="Help.html">Help</a><span class="nav-separator">|</span>
  <a href="Downloads.html">Downloads</a><span class="nav-separator">|</span>
  <a href="Create.html">Create</a>
</div>

<div id="notice">Loading...</div>
<div id="page-content"></div>
<div id="footer">© 2025, Venux — All rights reserved</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, arrayUnion, deleteDoc, getDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBPmJ-QYXZ41gx-4PjCpUPuw7DLnDq0JFg",
  authDomain: "venux1.firebaseapp.com",
  projectId: "venux1",
  storageBucket: "venux1.appspot.com",
  messagingSenderId: "231055963335",
  appId: "1:231055963335:web:34c2f52fca2191b3d0bae2",
  measurementId: "G-N36RRV95SW"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const noticeBar = document.getElementById("notice");
const authButtons = document.getElementById("authButtons");
const pageContent = document.getElementById("page-content");

let currentUser = null;

fetch("https://raw.githubusercontent.com/ayytrix/ventest1/refs/heads/main/anc")
  .then(r => r.ok ? r.text() : "Welcome to Venux Forums!")
  .then(t => noticeBar.textContent = t)
  .catch(() => noticeBar.textContent = "Welcome to Venux Forums!");

onAuthStateChanged(auth, async (user) => {
  if(!user){ window.location.href="Login.html"; return; }
  currentUser = user;

  const userSnap = await getDoc(doc(db,"users",user.uid));
  const username = userSnap.exists() && userSnap.data().username ? userSnap.data().username : "User";
  const numericUserId = userSnap.exists() && userSnap.data().userId ? userSnap.data().userId : 0;

  authButtons.innerHTML = `<span>Welcome, ${username}</span> <button class="logout-btn" id="logoutBtn">Logout</button>`;
  document.getElementById("logoutBtn").addEventListener("click", async ()=>{ await signOut(auth); window.location.href="Login.html"; });

  pageContent.innerHTML = `
    <h2>Forums</h2>
    <div>
      <input type="text" id="threadTitle" placeholder="Thread title">
      <textarea id="threadBody" placeholder="Thread content"></textarea>
      <button id="postThread" class="submit-btn">Post Thread</button>
    </div>
    <div id="threadsContainer"></div>
  `;

  const threadsContainer = document.getElementById("threadsContainer");

  async function loadThreads(){
    threadsContainer.innerHTML = "";
    const threadsSnap = await getDocs(query(collection(db,"threads"), orderBy("date","desc")));
    let threadsArray = [];
    threadsSnap.forEach(docSnap => threadsArray.push({ id: docSnap.id, data: docSnap.data() }));

    // Sort pinned on top
    threadsArray.sort((a,b) => (b.data.pinned?1:0) - (a.data.pinned?1:0));

    for(const tObj of threadsArray){
      const tDocId = tObj.id;
      const t = tObj.data;
      const authorSnap = await getDoc(doc(db,"users",t.uid));
      const authorName = authorSnap.exists()?authorSnap.data().username:"User";
      const authorUserId = authorSnap.exists()?authorSnap.data().userId:t.uid;
      const usernameColor = (authorUserId===1||authorUserId===2)?"darkred":"black";
      const adminBadge = (authorUserId===1||authorUserId===2||authorUserId===5)?" <span style='color:#8b0000;font-weight:bold'>(Admin)</span>":"";

      // UPDATED: Profile links point to Users.html
      let threadHTML = `<div class="thread-box" id="thread-${tDocId}">
        <div class="thread-title ${t.pinned?'pinned':''}">${t.title}</div>
        <div class="thread-meta"><a class="username-link" href="Users.html?userId=${authorUserId}" style="color:${usernameColor}">${authorName}</a>${adminBadge} - ${t.date}</div>
        <div class="thread-body">${t.body}</div>`;

      if(numericUserId===1||numericUserId===2){
        threadHTML += `<button class="pin-btn" data-threadid="${tDocId}">${t.pinned?"Unpin":"Pin"}</button>`;
      }
      if(user.uid===t.uid){
        threadHTML += `<button class="delete-btn" data-threadid="${tDocId}">Delete</button>`;
      }

      const replyCount = t.replies?.length || 0;
      threadHTML += `<button class="view-replies-btn" data-threadid="${tDocId}">View Replies (${replyCount})</button>
        <div class="replies-container" id="replies-${tDocId}">`;

      t.replies?.forEach(r=>{
        threadHTML += `<div class="reply-box"><a class="username-link" href="Users.html?userId=${r.userId}" style="color:${(r.userId===1||r.userId===2)?'darkred':'black'}">${r.username}</a>: ${r.text}</div>`;
      });

      threadHTML += `<textarea placeholder="Reply..." data-threadid="${tDocId}" class="reply-input"></textarea>
        <button class="reply-btn" data-threadid="${tDocId}">Reply</button></div></div>`;

      threadsContainer.innerHTML += threadHTML;
    }

    // Listeners
    document.querySelectorAll(".pin-btn").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const ref = doc(db,"threads",btn.dataset.threadid);
        const tSnap = await getDoc(ref);
        if(tSnap.exists()){
          await updateDoc(ref,{ pinned: !(tSnap.data().pinned||false) });
          loadThreads();
        }
      });
    });

    document.querySelectorAll(".delete-btn").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        if(confirm("Delete this thread?")){
          await deleteDoc(doc(db,"threads",btn.dataset.threadid));
          loadThreads();
        }
      });
    });

    document.querySelectorAll(".reply-btn").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const threadId = btn.dataset.threadid;
        const input = document.querySelector(`.reply-input[data-threadid='${threadId}']`);
        const text = input.value.trim();
        if(!text) return;
        await updateDoc(doc(db,"threads",threadId), { replies: arrayUnion({ userId:numericUserId, username, text }) });
        input.value="";
        loadThreads();
      });
    });

    document.querySelectorAll(".view-replies-btn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const container = document.getElementById(`replies-${btn.dataset.threadid}`);
        container.style.display = container.style.display==="none"?"block":"none";
      });
    });
  }

  await loadThreads();

  document.getElementById("postThread").addEventListener("click", async ()=>{
    const title = document.getElementById("threadTitle").value.trim();
    const body = document.getElementById("threadBody").value.trim();
    if(!title || !body) return alert("Enter title and body");
    await addDoc(collection(db,"threads"),{ uid:user.uid, title, body, date:new Date().toLocaleString(), replies:[], pinned:false });
    document.getElementById("threadTitle").value="";
    document.getElementById("threadBody").value="";
    loadThreads();
  });

});
</script>
</body>
</html>
