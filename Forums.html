<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Venux - Forums</title>
<style>
body {
  margin:0;
  font-family:Arial,sans-serif;
  background:#d4d4d4;
  color:#222;
  font-size:13px;
}
#main-header, #sub-header {
  background:linear-gradient(to bottom,#1a4a84 0%,#0b2c5a 100%);
  padding:10px 20px;
  display:flex;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
}
#main-header img { height:52px; object-fit:contain; }
#sub-header a {
  color:white;
  text-decoration:none;
  margin-right:10px;
  font-weight:bold;
  padding:6px 10px;
  border-radius:4px;
}
#sub-header a:hover { background:linear-gradient(to bottom,#1f5da0 0%,#0e3670 100%); }
.nav-separator { color:white; margin-right:10px; }
.auth-buttons button { cursor:pointer; border:none; border-radius:4px; font-weight:bold; padding:6px 10px; }
.logout-btn { background:linear-gradient(to bottom,#f44336 0%,#da190b 100%); color:white; }
.logout-btn:hover { background:linear-gradient(to bottom,#da190b 0%,#f44336 100%); }
#notice { background:linear-gradient(to bottom,#ffa200 0%,#cc7a00 100%); color:white; padding:10px 20px; font-weight:bold; text-align:center; border-bottom:2px solid #a85f00; }
#page-content { padding:20px; }
.thread, .reply { background:#fff; border:2px solid #999; padding:10px; margin-bottom:10px; border-radius:4px; }
.thread-header { font-weight:bold; margin-bottom:6px; }
.thread-body, .reply-body { margin-bottom:6px; }
button { margin-left:5px; }
.reply-container { margin-left:20px; margin-top:10px; }
#footer { text-align:center; font-size:12px; color:#444; padding:10px; border-top:2px solid #999; background:linear-gradient(to bottom,#f3f3f3 0%,#d8d8d8 100%); margin-top:40px; }
</style>
</head>
<body>

<div id="main-header">
  <img src="https://raw.githubusercontent.com/ayytrix/ventest1/refs/heads/main/venux.png" alt="Venux">
  <div class="auth-buttons" id="authButtons"></div>
</div>

<div id="sub-header">
  <a href="Home.html">Home</a><span class="nav-separator">|</span>
  <a href="Games.html">Games</a><span class="nav-separator">|</span>
  <a href="Catalog.html">Catalog</a><span class="nav-separator">|</span>
  <a href="Users.html">Users</a><span class="nav-separator">|</span>
  <a href="Forums.html">Forum</a><span class="nav-separator">|</span>
  <a href="Clans.html">Clans</a><span class="nav-separator">|</span>
  <a href="Help.html">Help</a><span class="nav-separator">|</span>
  <a href="Downloads.html">Downloads</a><span class="nav-separator">|</span>
  <a href="Create.html">Create</a>
</div>

<div id="notice">Loading...</div>
<div id="page-content">
  <h2>Forums</h2>
  <div>
    <input type="text" id="threadTitle" placeholder="Thread title" style="width:300px;">
    <button id="postThreadBtn">Post Thread</button>
  </div>
  <div id="forumContainer"></div>
</div>

<div id="footer">© 2025, Venux — All rights reserved</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
import { getFirestore, collection, getDocs, addDoc, doc, updateDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBPmJ-QYXZ41gx-4PjCpUPuw7DLnDq0JFg",
  authDomain: "venux1.firebaseapp.com",
  projectId: "venux1",
  storageBucket: "venux1.appspot.com",
  messagingSenderId: "231055963335",
  appId: "1:231055963335:web:34c2f52fca2191b3d0bae2",
  measurementId: "G-N36RRV95SW"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const authButtons = document.getElementById("authButtons");
const forumContainer = document.getElementById("forumContainer");
const postThreadBtn = document.getElementById("postThreadBtn");
const threadTitleInput = document.getElementById("threadTitle");
const noticeBar = document.getElementById("notice");

let currentUser;

onAuthStateChanged(auth, async (user) => {
  if(!user) { window.location.href="Login.html"; return; }
  currentUser = user;
  authButtons.innerHTML = `<span>Welcome, ${user.displayName || "User"}</span> <button class="logout-btn" id="logoutBtn">Logout</button>`;
  document.getElementById("logoutBtn").addEventListener("click", async ()=>{
    await signOut(auth);
    window.location.href="Login.html";
  });
  loadThreads();
});

async function loadThreads(){
  forumContainer.innerHTML = "";
  const threadsRef = collection(db, "forums");
  const q = query(threadsRef, orderBy("createdAt","desc"));
  const snapshot = await getDocs(q);
  snapshot.forEach(docSnap=>{
    const data = docSnap.data();
    const threadEl = document.createElement("div");
    threadEl.className = "thread";

    // Thread header with clickable username
    const threadHeader = document.createElement("div");
    threadHeader.className = "thread-header";
    const userLink = document.createElement("a");
    userLink.href = `Profile.html?userId=${data.userId}`;
    userLink.textContent = data.username;
    if(data.userId === 1 || data.userId === 2) userLink.style.color = "#8b0000"; // dark red for admins
    threadHeader.appendChild(userLink);
    threadHeader.appendChild(document.createTextNode(`: ${data.title}`));

    // Pin button for userId 1 & 2
    if(currentUser.uid === data.authorUid && (data.userId === 1 || data.userId === 2)){
      const pinBtn = document.createElement("button");
      pinBtn.textContent = data.pinned ? "Unpin" : "Pin";
      pinBtn.onclick = async () => {
        await updateDoc(doc(db,"forums",docSnap.id),{pinned:!data.pinned});
        loadThreads();
      };
      threadHeader.appendChild(pinBtn);
    }

    // Delete button for author
    if(currentUser.uid === data.authorUid){
      const delBtn = document.createElement("button");
      delBtn.textContent = "Delete";
      delBtn.onclick = async () => {
        await deleteDoc(doc(db,"forums",docSnap.id));
        loadThreads();
      };
      threadHeader.appendChild(delBtn);
    }

    threadEl.appendChild(threadHeader);

    // Replies
    const replyContainer = document.createElement("div");
    replyContainer.className = "reply-container";
    if(data.replies) data.replies.forEach(reply=>{
      const replyEl = document.createElement("div");
      replyEl.className = "reply";
      const replyHeader = document.createElement("div");
      replyHeader.className = "thread-header";
      const replyLink = document.createElement("a");
      replyLink.href = `Profile.html?userId=${reply.userId}`;
      replyLink.textContent = reply.username;
      if(reply.userId === 1 || reply.userId === 2) replyLink.style.color="#8b0000";
      replyHeader.appendChild(replyLink);
      replyHeader.appendChild(document.createTextNode(`: ${reply.text}`));
      replyEl.appendChild(replyHeader);
      replyContainer.appendChild(replyEl);
    });
    threadEl.appendChild(replyContainer);

    // Reply input
    const replyInput = document.createElement("input");
    replyInput.type="text";
    replyInput.placeholder="Write a reply...";
    replyInput.style.width="250px";
    const replyBtn = document.createElement("button");
    replyBtn.textContent="Reply";
    replyBtn.onclick = async ()=>{
      const text = replyInput.value.trim();
      if(!text) return;
      const threadRef = doc(db,"forums",docSnap.id);
      await updateDoc(threadRef,{
        replies: [...(data.replies||[]), {
          userId: data.userId,
          username: currentUser.displayName||"User",
          text: text
        }]
      });
      loadThreads();
    };
    threadEl.appendChild(replyInput);
    threadEl.appendChild(replyBtn);

    forumContainer.appendChild(threadEl);
  });
}

// Post new thread
postThreadBtn.addEventListener("click", async ()=>{
  const title = threadTitleInput.value.trim();
  if(!title) return;
  await addDoc(collection(db,"forums"),{
    title: title,
    userId: parseInt(currentUser.displayName || "0"),
    username: currentUser.displayName || "User",
    authorUid: currentUser.uid,
    pinned: false,
    replies: [],
    createdAt: new Date()
  });
  threadTitleInput.value = "";
  loadThreads();
});
</script>

</body>
</html>
