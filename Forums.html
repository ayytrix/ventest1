<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Venux - Forums</title>
<style>
body { margin:0; font-family:Arial,sans-serif; background:#d4d4d4; color:#222; font-size:13px; }
#main-header { background:linear-gradient(to bottom,#1a4a84 0%,#0b2c5a 100%); padding:10px 20px; display:flex; justify-content:space-between; align-items:center; }
#main-header img { height:52px; object-fit:contain; }
.auth-buttons { display:flex; align-items:center; gap:10px; color:white; }
.logout-btn { padding:8px 15px; border:none; border-radius:4px; font-weight:bold; cursor:pointer; font-size:12px; background:linear-gradient(to bottom,#f44336 0%,#da190b 100%); color:white; transition: all 0.3s ease; }
.logout-btn:hover { background:linear-gradient(to bottom,#da190b 0%,#f44336 100%); }
#sub-header { background:linear-gradient(to bottom,#1a4a84 0%,#0b2c5a 100%); padding:8px 15px; border-bottom:1px solid #000000; }
#sub-header a { color:white; text-decoration:none; margin:0 10px 0 0; font-weight:bold; padding:6px 10px; border-radius:4px; transition: all 0.3s ease; }
#sub-header a:hover { background:linear-gradient(to bottom,#1f5da0 0%,#0e3670 100%); text-decoration:none; }
.nav-separator { color:white; margin:0 10px 0 0; }
#notice { background:linear-gradient(to bottom,#ffa200 0%,#cc7a00 100%); color:white; padding:10px 20px; font-weight:bold; text-align:center; border-bottom:2px solid #a85f00; }
#page-content { padding:20px; }
.thread-box { background:linear-gradient(to bottom,#fff 0%,#e2e2e2 100%); border:2px solid #999; padding:12px; margin-bottom:15px; width:700px; box-shadow:2px 2px 0 #aaa; }
.thread-title { font-weight:bold; font-size:14px; margin-bottom:6px; }
.thread-title.pinned { color:gold; }
.thread-meta { font-size:11px; color:#666; margin-bottom:6px; }
.thread-body { font-size:13px; margin-bottom:10px; }
.reply-box { background:#f0f0f0; border:1px solid #bbb; padding:6px; margin-bottom:6px; border-radius:4px; }
.username-link { font-weight:bold; text-decoration:none; }
#footer { text-align:center; font-size:12px; color:#444; padding:10px; border-top:2px solid #999; background:linear-gradient(to bottom,#f3f3f3 0%,#d8d8d8 100%); margin-top:40px; }
input, textarea { width:100%; padding:6px; margin-bottom:6px; font-size:13px; border-radius:4px; border:1px solid #999; }
button { padding:6px 12px; border:none; border-radius:4px; font-weight:bold; cursor:pointer; margin-right:5px; }
.submit-btn { background:linear-gradient(to bottom,#1a4a84 0%,#0b2c5a 100%); color:white; }
.submit-btn:hover { background:linear-gradient(to bottom,#255da3 0%,#0d3268 100%); }
.pin-btn { background:orange; color:white; margin-left:5px; }
.delete-btn { background:red; color:white; margin-left:5px; }
.reply-btn { background:#1a4a84; color:white; margin-top:4px; }
.view-replies-btn { background:#555; color:white; margin-top:4px; margin-left:5px; }
.like-btn, .dislike-btn, .reply-like-btn, .reply-dislike-btn {
  background:#ddd; border:1px solid #999; border-radius:3px; font-size:12px; margin-right:5px;
}
.like-btn:hover, .reply-like-btn:hover { background:#aaffaa; }
.dislike-btn:hover, .reply-dislike-btn:hover { background:#ffaaaa; }
.replies-container { display:none; margin-top:6px; margin-left:12px; border-left:2px solid #aaa; padding-left:6px; }
</style>
</head>
<body>

<div id="main-header">
  <img src="https://raw.githubusercontent.com/ayytrix/ventest1/refs/heads/main/venux.png" alt="Venux">
  <div class="auth-buttons" id="authButtons"></div>
</div>

<div id="sub-header">
  <a href="Home.html">Home</a><span class="nav-separator">|</span>
  <a href="Games.html">Games</a><span class="nav-separator">|</span>
  <a href="Catalog.html">Catalog</a><span class="nav-separator">|</span>
  <a href="Users.html">Users</a><span class="nav-separator">|</span>
  <a href="Forums.html">Forum</a><span class="nav-separator">|</span>
  <a href="Clans.html">Clans</a><span class="nav-separator">|</span>
  <a href="Help.html">Help</a><span class="nav-separator">|</span>
  <a href="Downloads.html">Downloads</a><span class="nav-separator">|</span>
  <a href="Create.html">Create</a>
</div>

<div id="notice">Loading...</div>
<div id="page-content"></div>
<div id="footer">¬© 2025, Venux ‚Äî All rights reserved</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, arrayUnion, deleteDoc, getDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBPmJ-QYXZ41gx-4PjCpUPuw7DLnDq0JFg",
  authDomain: "venux1.firebaseapp.com",
  projectId: "venux1",
  storageBucket: "venux1.appspot.com",
  messagingSenderId: "231055963335",
  appId: "1:231055963335:web:34c2f52fca2191b3d0bae2",
  measurementId: "G-N36RRV95SW"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const noticeBar = document.getElementById("notice");
const authButtons = document.getElementById("authButtons");
const pageContent = document.getElementById("page-content");

let currentUser = null;
let username = "User";
let numericUserId = 0;

fetch("https://raw.githubusercontent.com/ayytrix/ventest1/refs/heads/main/anc")
  .then(r => r.ok ? r.text() : "Welcome to Venux Forums!")
  .then(t => noticeBar.textContent = t)
  .catch(() => noticeBar.textContent = "Welcome to Venux Forums!");

onAuthStateChanged(auth, async (user) => {
  if(!user){ window.location.href="Login.html"; return; }
  currentUser = user;

  const userSnap = await getDoc(doc(db,"users",user.uid));
  if(userSnap.exists()){
    username = userSnap.data().username || "User";
    numericUserId = userSnap.data().userId || 0;
  }

  authButtons.innerHTML = `<span>Welcome, ${username}</span> <button class="logout-btn" id="logoutBtn">Logout</button>`;
  document.getElementById("logoutBtn").addEventListener("click", async ()=>{ await signOut(auth); window.location.href="Login.html"; });

  pageContent.innerHTML = `
    <h2>Forums</h2>
    <div>
      <input type="text" id="threadTitle" placeholder="Thread title">
      <textarea id="threadBody" placeholder="Thread content"></textarea>
      <button id="postThread" class="submit-btn">Post Thread</button>
    </div>
    <div id="threadsContainer"></div>
  `;

  const threadsContainer = document.getElementById("threadsContainer");

  async function loadThreads(){
    threadsContainer.innerHTML = "";
    const threadsSnap = await getDocs(query(collection(db,"threads"), orderBy("date","desc")));
    let threadsArray = [];
    threadsSnap.forEach(docSnap => threadsArray.push({ id: docSnap.id, data: docSnap.data() }));

    // pinned first
    threadsArray.sort((a,b)=>(b.data.pinned?1:0)-(a.data.pinned?1:0));

    for(const tObj of threadsArray){
      const tDocId = tObj.id;
      const t = tObj.data;

      let authorName = "User";
      let authorUserId = 0;
      if(t.uid){
        try{
          const authorRef = doc(db,"users",t.uid);
          const authorSnap = await getDoc(authorRef);
          if(authorSnap.exists()){
            const aData = authorSnap.data();
            authorName = aData.username || "User";
            authorUserId = aData.userId || 0;
          }
        }catch(err){ console.warn("User fetch error:", err); }
      }

      const usernameColor = (authorUserId===1||authorUserId===2)?"darkred":"black";
      const adminBadge = (authorUserId===1||authorUserId===2||authorUserId===5)?" <span style='color:#8b0000;font-weight:bold'>(Admin)</span>":"";

      const likes = t.likes || [];
      const dislikes = t.dislikes || [];
      const likeCount = likes.length;
      const dislikeCount = dislikes.length;
      const userLiked = likes.includes(numericUserId);
      const userDisliked = dislikes.includes(numericUserId);

      let threadHTML = `<div class="thread-box" id="thread-${tDocId}">
        <div class="thread-title ${t.pinned?'pinned':''}">${t.title}</div>
        <div class="thread-meta">
          <a class="username-link" href="profile?userId=${authorUserId}" style="color:${usernameColor}">${authorName}</a>${adminBadge} - ${t.date}
        </div>
        <div class="thread-body">${t.body}</div>
        <button class="like-btn" data-id="${tDocId}">üëç ${likeCount}</button>
        <button class="dislike-btn" data-id="${tDocId}">üëé ${dislikeCount}</button>`;

      if(numericUserId===1||numericUserId===2||numericUserId===5||user.uid===t.uid){
        threadHTML += `<button class="delete-btn" data-id="${tDocId}">Delete</button>`;
      }
      if(numericUserId===1||numericUserId===2||numericUserId===5){
        threadHTML += `<button class="pin-btn" data-id="${tDocId}">${t.pinned?"Unpin":"Pin"}</button>`;
      }

      const replies = t.replies || [];
      threadHTML += `<button class="view-replies-btn" data-id="${tDocId}">View Replies (${replies.length})</button>
      <div class="replies-container" id="replies-${tDocId}">`;

      replies.forEach((r, idx)=>{
        const replyUserId = r.userId || 0;
        const replyName = r.username || "User";
        const replyColor = (replyUserId===1||replyUserId===2)?"darkred":"black";
        const rLikes = r.likes || [];
        const rDislikes = r.dislikes || [];
        threadHTML += `<div class="reply-box">
          <a class="username-link" href="profile?userId=${replyUserId}" style="color:${replyColor}">${replyName}</a>: ${r.text}
          <br>
          <button class="reply-like-btn" data-thread="${tDocId}" data-index="${idx}">üëç ${rLikes.length}</button>
          <button class="reply-dislike-btn" data-thread="${tDocId}" data-index="${idx}">üëé ${rDislikes.length}</button>
        </div>`;
      });

      threadHTML += `<textarea placeholder="Reply..." data-id="${tDocId}" class="reply-input"></textarea>
        <button class="reply-btn" data-id="${tDocId}">Reply</button>
      </div></div>`;

      threadsContainer.innerHTML += threadHTML;
    }

    // like/dislike
    document.querySelectorAll(".like-btn").forEach(btn=>{
      btn.onclick = async ()=>{
        const ref = doc(db,"threads",btn.dataset.id);
        const snap = await getDoc(ref);
        if(!snap.exists())return;
        const d = snap.data();
        const likes = d.likes || [];
        const dislikes = d.dislikes || [];
        let newLikes = likes.includes(numericUserId)?likes.filter(i=>i!==numericUserId):[...likes,numericUserId];
        let newDislikes = dislikes.filter(i=>i!==numericUserId);
        await updateDoc(ref,{likes:newLikes,dislikes:newDislikes});
        loadThreads();
      };
    });
    document.querySelectorAll(".dislike-btn").forEach(btn=>{
      btn.onclick = async ()=>{
        const ref = doc(db,"threads",btn.dataset.id);
        const snap = await getDoc(ref);
        if(!snap.exists())return;
        const d = snap.data();
        const likes = d.likes || [];
        const dislikes = d.dislikes || [];
        let newDislikes = dislikes.includes(numericUserId)?dislikes.filter(i=>i!==numericUserId):[...dislikes,numericUserId];
        let newLikes = likes.filter(i=>i!==numericUserId);
        await updateDoc(ref,{likes:newLikes,dislikes:newDislikes});
        loadThreads();
      };
    });

    // reply like/dislike
    document.querySelectorAll(".reply-like-btn").forEach(btn=>{
      btn.onclick = async ()=>{
        const ref = doc(db,"threads",btn.dataset.thread);
        const snap = await getDoc(ref);
        if(!snap.exists())return;
        const d = snap.data();
        const replies = d.replies || [];
        const idx = parseInt(btn.dataset.index);
        if(!replies[idx])return;
        const r = replies[idx];
        const likes = r.likes || [];
        const dislikes = r.dislikes || [];
        r.likes = likes.includes(numericUserId)?likes.filter(i=>i!==numericUserId):[...likes,numericUserId];
        r.dislikes = dislikes.filter(i=>i!==numericUserId);
        replies[idx]=r;
        await updateDoc(ref,{replies});
        loadThreads();
      };
    });
    document.querySelectorAll(".reply-dislike-btn").forEach(btn=>{
      btn.onclick = async ()=>{
        const ref = doc(db,"threads",btn.dataset.thread);
        const snap = await getDoc(ref);
        if(!snap.exists())return;
        const d = snap.data();
        const replies = d.replies || [];
        const idx = parseInt(btn.dataset.index);
        if(!replies[idx])return;
        const r = replies[idx];
        const likes = r.likes || [];
        const dislikes = r.dislikes || [];
        r.dislikes = dislikes.includes(numericUserId)?dislikes.filter(i=>i!==numericUserId):[...dislikes,numericUserId];
        r.likes = likes.filter(i=>i!==numericUserId);
        replies[idx]=r;
        await updateDoc(ref,{replies});
        loadThreads();
      };
    });

    // delete/pin/reply toggle
    document.querySelectorAll(".delete-btn").forEach(btn=>{
      btn.onclick = async ()=>{
        if(confirm("Delete this thread?")){
          await deleteDoc(doc(db,"threads",btn.dataset.id));
          loadThreads();
        }
      };
    });
    document.querySelectorAll(".pin-btn").forEach(btn=>{
      btn.onclick = async ()=>{
        const ref = doc(db,"threads",btn.dataset.id);
        const snap = await getDoc(ref);
        if(!snap.exists())return;
        await updateDoc(ref,{pinned:!(snap.data().pinned||false)});
        loadThreads();
      };
    });
    document.querySelectorAll(".view-replies-btn").forEach(btn=>{
      btn.onclick = ()=>{
        const cont = document.getElementById(`replies-${btn.dataset.id}`);
        cont.style.display = cont.style.display==="none"?"block":"none";
      };
    });
    document.querySelectorAll(".reply-btn").forEach(btn=>{
      btn.onclick = async ()=>{
        const id = btn.dataset.id;
        const input = document.querySelector(`.reply-input[data-id='${id}']`);
        const text = input.value.trim();
        if(!text)return;
        const ref = doc(db,"threads",id);
        await updateDoc(ref,{replies:arrayUnion({userId:numericUserId,username,text,likes:[],dislikes:[]})});
        input.value="";
        loadThreads();
      };
    });
  }

  await loadThreads();

  document.getElementById("postThread").addEventListener("click", async ()=>{
    const title = document.getElementById("threadTitle").value.trim();
    const body = document.getElementById("threadBody").value.trim();
    if(!title || !body) return alert("Enter title and body");
    await addDoc(collection(db,"threads"),{ uid:user.uid, title, body, date:new Date().toLocaleString(), replies:[], pinned:false, likes:[], dislikes:[] });
    document.getElementById("threadTitle").value="";
    document.getElementById("threadBody").value="";
    loadThreads();
  });
});
</script>
</body>
</html>
