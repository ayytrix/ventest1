<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Venux - Profile</title>
<style>
/* ... (keep your existing CSS, same as before) ... */
</style>
</head>
<body>

<div id="main-header">
  <img src="https://raw.githubusercontent.com/ayytrix/ventest1/refs/heads/main/venux.png" alt="Venux">
  <div class="nav-links" id="authNavLinks"></div>
</div>

<div id="notice">Loading...</div>

<div id="page-content">
  <div class="profile-header">
    <div class="avatar-placeholder"></div>
    <div class="profile-username" id="profileUsername"></div>
  </div>

  <div id="description"></div>

  <div id="profileButtons">
    <button class="edit-btn" id="editDescriptionBtn" style="display:none;">Edit Description</button>
    <button class="theme-btn" id="editThemeBtn" style="display:none;">Edit Theme</button>
  </div>

  <div id="friendRequestsContainer">
    <h3>Friend Requests</h3>
    <div id="friendRequestsList"></div>
  </div>

  <div id="badges">
    <strong>Player Badges:</strong>
    <span id="badgeContainer"></span>
  </div>
</div>

<div id="footer">Â© 2025, Venux All rights reserved</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
import { getFirestore, collection, query, where, getDocs, doc, setDoc, updateDoc, deleteDoc, arrayUnion, getDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBPmJ-QYXZ41gx-4PjCpUPuw7DLnDq0JFg",
  authDomain: "venux1.firebaseapp.com",
  projectId: "venux1",
  storageBucket: "venux1.appspot.com",
  messagingSenderId: "231055963335",
  appId: "1:231055963335:web:34c2f52fca2191b3d0bae2",
  measurementId: "G-N36RRV95SW"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const noticeBar = document.getElementById("notice");
const authNavLinks = document.getElementById("authNavLinks");
const profileUsername = document.getElementById("profileUsername");
const descriptionDiv = document.getElementById("description");
const badgeContainer = document.getElementById("badgeContainer");
const editDescriptionBtn = document.getElementById("editDescriptionBtn");
const editThemeBtn = document.getElementById("editThemeBtn");
const friendRequestsList = document.getElementById("friendRequestsList");

const urlParams = new URLSearchParams(window.location.search);
const viewingUserId = parseInt(urlParams.get('userId'), 10);

async function getUserByNumericId(userId) {
  const usersRef = collection(db, "users");
  const q = query(usersRef, where("userId", "==", userId));
  const snapshot = await getDocs(q);
  if (!snapshot.empty) return snapshot.docs[0];
  return null;
}

onAuthStateChanged(auth, async (user) => {
  if (!user) { window.location.href = "Login.html"; return; }
  const currentUserId = user.uid;

  // Navbar
  authNavLinks.innerHTML = `
    <a href="Home.html">Home</a>
    <a href="Games.html">Games</a>
    <a href="Catalog.html">Catalog</a>
    <a href="Users.html">Users</a>
    <button class="button logout-btn" id="logoutBtn">Logout</button>
  `;
  document.getElementById("logoutBtn").addEventListener("click", async ()=>{ await signOut(auth); window.location.href="Login.html"; });

  // Load profile
  let userDoc;
  if(viewingUserId){
    userDoc = await getUserByNumericId(viewingUserId);
    if(!userDoc){ noticeBar.textContent = "User not found"; return; }
  } else {
    const usersRef = collection(db,"users");
    const q = query(usersRef, where("uid","==",currentUserId));
    const snapshot = await getDocs(q);
    if(snapshot.empty){ noticeBar.textContent="User not found"; return; }
    userDoc = snapshot.docs[0];
  }

  const data = userDoc.data();
  const isOwner = currentUserId === userDoc.id;

  profileUsername.textContent = data.username || "User";
  descriptionDiv.innerHTML = `<p>${data.description || "This user hasn't added a description yet."}</p>`;

  // Friend button
  if(!isOwner){
    const friendBtn = document.createElement("button");
    friendBtn.className = "friend-btn";
    friendBtn.textContent = "Add Friend";
    descriptionDiv.appendChild(friendBtn);

    // Check if already friends or request sent
    const requestsSnapshot = await getDocs(collection(db, "users", userDoc.id, "friendRequests"));
    const requestSent = requestsSnapshot.docs.some(docSnap => docSnap.data().from === currentUserId);
    if((data.friends || []).includes(currentUserId) || requestSent){
      friendBtn.disabled = true;
      friendBtn.textContent = (data.friends || []).includes(currentUserId) ? "Friends" : "Request Sent";
    }

    friendBtn.addEventListener("click", async ()=>{
      try {
        await setDoc(doc(db,"users",userDoc.id,"friendRequests", currentUserId), {from: currentUserId});
        friendBtn.disabled = true;
        friendBtn.textContent = "Request Sent";
      } catch(err){ alert("Could not send friend request: " + err.message); }
    });
  }

  // Display incoming requests (for owner)
  if(isOwner){
    const requestsSnapshot = await getDocs(collection(db, "users", userDoc.id, "friendRequests"));
    friendRequestsList.innerHTML = "";
    for(const reqDoc of requestsSnapshot.docs){
      const fromUid = reqDoc.data().from;
      const fromUserDoc = await getDoc(doc(db,"users",fromUid));
      const fromUsername = fromUserDoc.exists() ? fromUserDoc.data().username : "Unknown";
      const div = document.createElement("div");
      div.textContent = fromUsername + " ";
      const acceptBtn = document.createElement("button");
      acceptBtn.textContent = "Accept";
      acceptBtn.addEventListener("click", async ()=>{
        // Add to friends array
        await updateDoc(doc(db,"users",currentUserId), {friends: arrayUnion(fromUid)});
        // Delete request
        await deleteDoc(doc(db,"users",currentUserId,"friendRequests",reqDoc.id));
        div.remove();
      });
      div.appendChild(acceptBtn);
      friendRequestsList.appendChild(div);
    }
  }

});
</script>

</body>
</html>
