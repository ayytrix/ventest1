<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Venux - Admin Panel</title>
<style>
  body {margin:0; font-family:Arial,sans-serif; background:#d4d4d4; font-size:13px; display:flex; flex-direction:column;}
  #main-header {background:linear-gradient(to bottom,#1a4a84 0%,#0b2c5a 100%); padding:10px 20px; display:flex; justify-content:space-between; align-items:center;}
  #main-header img {height:52px;}
  #sub-header {background:linear-gradient(to bottom,#1a4a84 0%,#0b2c5a 100%); padding:8px 15px; border-bottom:1px solid #000;}
  #sub-header a {color:white; text-decoration:none; margin-right:10px; font-weight:bold;}
  #sub-header a:hover {text-decoration:underline;}
  table {width:100%; border-collapse:collapse; margin-top:20px;}
  th, td {border:1px solid #999; padding:8px; text-align:center;}
  button {padding:5px 10px; margin:2px; cursor:pointer;}
  .warn-btn {background:#ffa200;color:white;}
  .ban-btn {background:#f44336;color:white;}
  .terminate-btn {background:#000;color:white;}
  .unban-btn {background:#22c55e;color:white;}
  .unterminate-btn {background:#22c55e;color:white;}
  #footer {text-align:center; font-size:12px; color:#444; padding:10px; border-top:2px solid #999; background:linear-gradient(to bottom,#f3f3f3 0%,#d8d8d8 100%);}
</style>
</head>
<body>

<div id="main-header">
  <img src="https://raw.githubusercontent.com/ayytrix/ventest1/refs/heads/main/venux.png" alt="Venux">
</div>

<div id="sub-header">
  <a href="Home">Home</a>
  <a href="Users">Users</a>
  <a href="Forums">Forums</a>
  <button id="logoutBtn" style="float:right;">Logout</button>
</div>

<div id="page-content">
  <h2>Admin Panel - User Management</h2>
  <table id="usersTable">
    <thead>
      <tr>
        <th>User ID</th>
        <th>Username</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="footer">Â© 2025, Venux All rights reserved</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
import { getFirestore, collection, doc, getDocs, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBPmJ-QYXZ41gx-4PjCpUPuw7DLnDq0JFg",
  authDomain: "venux1.firebaseapp.com",
  projectId: "venux1",
  storageBucket: "venux1.appspot.com",
  messagingSenderId: "231055963335",
  appId: "1:231055963335:web:34c2f52fca2191b3d0bae2",
  measurementId: "G-N36RRV95SW"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const logoutBtn = document.getElementById("logoutBtn");
const usersTableBody = document.querySelector("#usersTable tbody");

// ADMIN AUTH
onAuthStateChanged(auth, async (user)=>{
  if(!user) return window.location.href="/error";

  const currentUserRef = doc(db,"users",user.uid);
  const currentUserSnap = await getDocs(collection(db,"users"));
  const currentUserData = (await currentUserRef.get()).data?.() || {}; 

  // Only allow admin IDs 1,2,5
  const adminIds = [1,2,5];
  const currentUserDocSnap = await getDocs(collection(db,"users"));
  let isAdmin=false;
  currentUserDocSnap.forEach(u=>{
    if(u.id===user.uid && adminIds.includes(u.data().userId)) isAdmin=true;
  });
  if(!isAdmin) return window.location.href="/error";

  logoutBtn.addEventListener("click", async ()=>{
    await updateDoc(currentUserRef,{ online:false, lastOnline:serverTimestamp() });
    await signOut(auth);
    window.location.href="/Login";
  });

  // LOAD USERS
  const usersSnap = await getDocs(collection(db,"users"));
  usersTableBody.innerHTML="";
  usersSnap.forEach(u=>{
    const d = u.data();
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${d.userId}</td>
      <td>${d.username}</td>
      <td>
        ${d.warned?"Warned":""} ${d.banned?"Banned":""} ${d.terminated?"Terminated":""}
      </td>
      <td>
        <button class="warn-btn">Warn</button>
        <button class="ban-btn">Ban</button>
        <button class="terminate-btn">Terminate</button>
        <button class="unban-btn">Unban</button>
        <button class="unterminate-btn">Unterminate</button>
      </td>
    `;
    usersTableBody.appendChild(tr);

    // BUTTON HOOKS
    const warnBtn = tr.querySelector(".warn-btn");
    const banBtn = tr.querySelector(".ban-btn");
    const terminateBtn = tr.querySelector(".terminate-btn");
    const unbanBtn = tr.querySelector(".unban-btn");
    const unterminateBtn = tr.querySelector(".unterminate-btn");

    // WARN
    warnBtn.addEventListener("click", async ()=>{
      const note = prompt("Enter moderator warning note:");
      if(!note) return;
      await updateDoc(u.ref,{ warned:true, warnNote:note, warnTimestamp:serverTimestamp() });
      alert(`${d.username} has been warned`);
      location.reload();
    });

    // BAN
    banBtn.addEventListener("click", async ()=>{
      const note = prompt("Enter moderator ban note:");
      if(!note) return;
      const days = parseInt(prompt("Days of ban:"),10) || 0;
      const hours = parseInt(prompt("Hours of ban:"),10) || 0;
      const until = new Date();
      until.setDate(until.getDate()+days);
      until.setHours(until.getHours()+hours);
      await updateDoc(u.ref,{ banned:true, banNote:note, banUntil:until, banTimestamp:serverTimestamp() });
      alert(`${d.username} has been banned`);
      location.reload();
    });

    // TERMINATE
    terminateBtn.addEventListener("click", async ()=>{
      const note = prompt("Enter moderator terminate note:");
      if(!note) return;
      await updateDoc(u.ref,{ terminated:true, terminateNote:note, username:"Account Terminated", description:"" });
      alert(`${d.username} account terminated`);
      location.reload();
    });

    // UNBAN
    unbanBtn.addEventListener("click", async ()=>{
      await updateDoc(u.ref,{ banned:false, banNote:"", banUntil:null });
      alert(`${d.username} unbanned`);
      location.reload();
    });

    // UNTERMINATE
    unterminateBtn.addEventListener("click", async ()=>{
      await updateDoc(u.ref,{ terminated:false });
      alert(`${d.username} unterminated`);
      location.reload();
    });
  });
});
</script>
</body>
</html>
